import{_ as l,o as e,c as a,e as n}from"./app-C2hHG5A5.js";const i={},p=n(`<h1 id="cloudflare以及防ddos策略详述" tabindex="-1"><a class="header-anchor" href="#cloudflare以及防ddos策略详述"><span>CloudFlare以及防DDOS策略详述</span></a></h1><h2 id="开篇" tabindex="-1"><a class="header-anchor" href="#开篇"><span>开篇</span></a></h2><blockquote><p>文章前言与应用场景</p></blockquote><p>国内任何服务器，不管大厂还是小厂，无论腾讯云还是杂牌云，只要面临DDOS攻击，一定是秒死。</p><p>即便是使用赫赫有名的高防服务器，除非预算十分充裕，不然也是会被上百千G的攻击所攻破。</p><p>DDOS需要拿到服务器IP，并对IP进行大量的洪水访问，以达到恶意流量超过阈值，服务器厂商会自动关停你的服务器。</p><p>所以很多人会使用CDN来达到隐藏真实IP的效果，但是中国的防御成本远远大于攻击成本。</p><p>所以本篇文章推荐一篇最低成本，无人可以攻击死的一种安全策略。</p><blockquote><p>说明：</p></blockquote><p>本篇思路来源于本人师傅教导，是被无数个同行和恶狗DDOS数十次，多年来CC和DDOS防御的项目经验，网上关于这类的文章几乎为0，我决定详细记录一下，技术无价、仅供参考。</p><h2 id="知识了解" tabindex="-1"><a class="header-anchor" href="#知识了解"><span>知识了解</span></a></h2><blockquote><p>先了解几个理论知识</p></blockquote><h3 id="dns服务器" tabindex="-1"><a class="header-anchor" href="#dns服务器"><span>DNS服务器</span></a></h3><p>DNS服务器主要用作域名访问时，对域名对应的ip进行查找并访问，因此总结DNS服务器作用为解析域名。</p><h3 id="cdn" tabindex="-1"><a class="header-anchor" href="#cdn"><span>CDN</span></a></h3><p>cdn等于为ip与DNS解析之间，加入了一个第三方的ip做流量中转，于是就实现了隐藏自己真实IP的目的，DDOS攻击到的也只能是CDN提供的IP了。因此，使用CDN的前提是服务器必须有域名。</p><p>CDN运行流程大概如下：</p><ol><li>DNS请求当地local DNS</li><li>当地local DNS递归地查询服务器的gslb</li><li>服务器根据local DNS 分配最佳节点，返回IP</li><li>用户获得最佳接入IP，访问最佳节点。</li><li>如果该节点没有用户想要获取的内容，则通过内部路由访问上一节点，直到找到文件或到达源站为止。</li><li>CDN节点缓存该数据，下次请求该文件可以直接返回。</li></ol><h2 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作"><span>准备工作</span></a></h2><p>先说结论，因为国内的CDN或高防服务器成本过高，我们可以采用国外CDN的方式，因为国外的CDN是免费的，且无限防御DDOS！</p><p>使用国外CDN也就需要使用国外的服务器，所以我们可以买任意一个香港、洛杉矶等地区的国外服务器。而CDN我们选用鼎鼎大名的CloudFlare，很多知名公司都在使用CloudFlare进行防御。域名也可以随便买一个，因为是国外服务器，解析到服务器上无需备案（国内买域名备案较为麻烦！）</p><p>本篇文章以腾讯云为例，域名和服务器均买自腾讯云。</p><h2 id="开始搭建" tabindex="-1"><a class="header-anchor" href="#开始搭建"><span>开始搭建</span></a></h2><h3 id="添加站点" tabindex="-1"><a class="header-anchor" href="#添加站点"><span>添加站点</span></a></h3><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908010753073.png" alt="image-20230908010753073"></p><p>然后选择免费的服务，购买即可</p><h3 id="替换dns" tabindex="-1"><a class="header-anchor" href="#替换dns"><span>替换DNS</span></a></h3><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908010936357.png" alt="image-20230908010936357"></p><p>按照CloudFlare所提示的，去腾讯云域名管理页面替换DNS为</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>felicity.ns.cloudflare.com
nicole.ns.cloudflare.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908011109499.png" alt="image-20230908011109499"></p><p>随后返回CloudFlare，开始检查DNS即可</p><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908011212181.png" alt="image-20230908011212181"></p><p>我们只需静待几分钟-几小时，等待CloudFlare发邮件提醒我们已经检查DNS成功了就可以了。</p><p>此时此刻，我们的域名已经和CloudFlare对接上了，所有访问域名的请求，都会由CloudFlare进行中转，我们再给CloudFlare配置上A记录以访问真实的服务器ip，即可完全实现流量中转。</p><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908011859265.png" alt="image-20230908011859265"></p><h3 id="测试访问" tabindex="-1"><a class="header-anchor" href="#测试访问"><span>测试访问</span></a></h3><p>此时给服务器上传网页文件即可实现访问了</p><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908012016410.png" alt="image-20230908012016410"></p><h2 id="问题改进" tabindex="-1"><a class="header-anchor" href="#问题改进"><span>问题改进</span></a></h2><p>经过以上操作，我们已经实现了CloudFlare与域名之间的相互解析，但是仍存在一些问题。</p><p>1、部分地区会对http域名进行安全策略拦截</p><p>2、一些高手仍能通过暴力手段来遍历出我们的真实IP，</p><p>3、CloudFlare提供的默认IP线路过于卡顿，不便于国内用户使用</p><p>所以我们要逐一解决他们</p><p>一、首先我们要在CloudFlare开启强制https，解决安全策略问题。</p><p>二、其次，我们要在Nginx中配置IP白名单，只允许CloudFlare官方的ip源进行访问</p><p>ip源获取地址：https://www.cloudflare.com/ips-v4</p><div class="language-ini line-numbers-mode" data-ext="ini" data-title="ini"><pre class="language-ini"><code>allow 173.245.48.0/20;
allow 103.21.244.0/22;
allow 103.22.200.0/22;
allow 103.31.4.0/22;
allow 141.101.64.0/18;
allow 108.162.192.0/18;
allow 190.93.240.0/20;
allow 188.114.96.0/20;
allow 197.234.240.0/22;
allow 198.41.128.0/17;
allow 162.158.0.0/15;
allow 104.16.0.0/13;
allow 104.24.0.0/14;
allow 172.64.0.0/13;
allow 131.0.72.0/22;
deny all;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>三、我们要将腾讯云的DNS解析换回腾讯云自己的，并使用第三方优选节点进行解析回CloudFlare，这样国内用户访问速度就可以大大提高了。</p><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908013534872.png" alt="image-20230908013534872"></p><p>国内优选线路：cf.13d7s.site</p><p>国外优选线路：域名+cf.13d7s.site</p><p>分别添加电信，移动，联通，和默认的优选线路，即可实现国内的优化以及国外的解析了。</p><p><img src="https://wqby-1304194722.cos.ap-nanjing.myqcloud.com/img/image-20230908013808855.png" alt="image-20230908013808855"></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>经过以上的操作，我们的网站几乎就是不会被打死了。</p><p>当然前提是所有对后端接口的调用，都要通过域名访问，同时配置Nginx转发来实现隐藏IP，不能给任何暴露真实IP的机会。</p><p>如果还想更完美的话，听臣一计：</p><p>我们可以将所有CRUD等操作放入国外服务器中，即使国外服务器死了，我们也可以快速另起一个服务器进行使用，并且不会保证数据丢失和功能受影响。</p><p>并且建立一个centerserver服务端放在国内做数据中转和核心功能运转，与国外带CloudFlare保护的服务器进行通信，数据库我们可以采用云数据库由第三方托管或者放入国内服务器。</p><p>与此同时，国外服务器尽管有了节点优选，部分地区例如河南，对于这方面IP限制也是极其严格，少量用户仍然存在打不开的情况下，大多数用户仍存在能访问但是网速较慢的情况。</p><p>于是我们便可以再买一台国内的服务器作为主用CRUD，将CloudFlare的域名302跳转到国内服务器，平时让用户一直使用国内的服务器作为信息交互，该国内服务器ip可以完全裸露，待国内服务器被打死的时候，我们只需要几秒钟关闭302，让CRUD服务器回归国外服务器，丝毫不会影响用户使用，核心功能都在CenterServer端，不会受任何影响。我们只需要趁着这段时间等待国内服务器复活，重新开启302即可。</p><p>但是没有十全的策略，既然选择了国外的0成本无限防御，就要承担中国长城防火墙带来的限速缺陷，如果有钱的话或者是项目比较正规公司，对用户体验感刚需，还是尽量直接买中国的物理机高防，一个月几千到几万不等。</p><p>对中Guo的某些政策一言难尽，希望有一天实现全民Vpn，让所有人突破这网络形式的闭关锁国，也不至于有现在如此多极端爱国主义，一叶障目的脑残行为出现。</p>`,65),s=[p];function d(c,o){return e(),a("div",null,s)}const t=l(i,[["render",d],["__file","CloudFlare以及防DDOS策略详述.html.vue"]]),h=JSON.parse('{"path":"/blog/CloudFlare%E4%BB%A5%E5%8F%8A%E9%98%B2DDOS%E7%AD%96%E7%95%A5%E8%AF%A6%E8%BF%B0.html","title":"CloudFlare以及防DDOS策略详述","lang":"en-US","frontmatter":{"title":"CloudFlare以及防DDOS策略详述","date":"2023-09-08T00:00:00.000Z","category":["History"],"tag":["网页","安全","教程"]},"headers":[{"level":2,"title":"开篇","slug":"开篇","link":"#开篇","children":[]},{"level":2,"title":"知识了解","slug":"知识了解","link":"#知识了解","children":[{"level":3,"title":"DNS服务器","slug":"dns服务器","link":"#dns服务器","children":[]},{"level":3,"title":"CDN","slug":"cdn","link":"#cdn","children":[]}]},{"level":2,"title":"准备工作","slug":"准备工作","link":"#准备工作","children":[]},{"level":2,"title":"开始搭建","slug":"开始搭建","link":"#开始搭建","children":[{"level":3,"title":"添加站点","slug":"添加站点","link":"#添加站点","children":[]},{"level":3,"title":"替换DNS","slug":"替换dns","link":"#替换dns","children":[]},{"level":3,"title":"测试访问","slug":"测试访问","link":"#测试访问","children":[]}]},{"level":2,"title":"问题改进","slug":"问题改进","link":"#问题改进","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"updatedTime":1709311174000,"contributors":[{"name":"wqby","email":"9479421@qq.com","commits":1}]},"filePathRelative":"blog/CloudFlare以及防DDOS策略详述.md","excerpt":"\\n<h2>开篇</h2>\\n<blockquote>\\n<p>文章前言与应用场景</p>\\n</blockquote>\\n<p>国内任何服务器，不管大厂还是小厂，无论腾讯云还是杂牌云，只要面临DDOS攻击，一定是秒死。</p>\\n<p>即便是使用赫赫有名的高防服务器，除非预算十分充裕，不然也是会被上百千G的攻击所攻破。</p>\\n<p>DDOS需要拿到服务器IP，并对IP进行大量的洪水访问，以达到恶意流量超过阈值，服务器厂商会自动关停你的服务器。</p>\\n<p>所以很多人会使用CDN来达到隐藏真实IP的效果，但是中国的防御成本远远大于攻击成本。</p>\\n<p>所以本篇文章推荐一篇最低成本，无人可以攻击死的一种安全策略。</p>"}');export{t as comp,h as data};
